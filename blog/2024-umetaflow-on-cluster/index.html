<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Research software engineering group at UiT</title>
    <link rel="shortcut icon" href="https://research-software.uit.no/img/favicon.ico">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.23.12/dist/css/uikit.min.css">
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.23.12/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.23.12/dist/js/uikit-icons.min.js"></script>

    
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/uit-no/rse/main/content/logo1.png" />



  <meta name="description" content="A step-by-step guide on how we installed UmetaFlow on the Saga cluster" />
  <meta name="twitter:description" content="A step-by-step guide on how we installed UmetaFlow on the Saga cluster" />



  <meta name="twitter:title" content="How we deployed UMetaFlow to a cluster" />



    <link href="https://research-software.uit.no/style.css" rel="stylesheet">
    <link href="https://research-software.uit.no/fonts.css" rel="stylesheet">
  </head>

  <body>
    <div class="uk-container uk-container-small uk-margin-large-bottom">

      

<nav class="uk-navbar-container uk-navbar-transparent" uk-navbar>
  <ul class="uk-navbar-nav uk-visible@s">
    
      
        <li><a href="https://research-software.uit.no">Home</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/services">Services</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/about">About us</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/courses">Courses</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/resources">Resources</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/projects">Projects</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/blog">Blog</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/testimonials">Testimonials</a></li>
      
    
      
        <li><a href="https://research-software.uit.no/contact">Contact</a></li>
      
    
  </ul>
  <a href="#" class="uk-navbar-toggle uk-hidden@s" uk-navbar-toggle-icon uk-toggle="target: #sidenav"></a>
</nav>

<div id="sidenav" uk-offcanvas="flip: true" class="uk-offcanvas">
  <div class="uk-offcanvas-bar">
    <ul class="uk-nav">
      
        
          <li><a href="https://research-software.uit.no">Home</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/services">Services</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/about">About us</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/courses">Courses</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/resources">Resources</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/projects">Projects</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/blog">Blog</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/testimonials">Testimonials</a></li>
        
      
        
          <li><a href="https://research-software.uit.no/contact">Contact</a></li>
        
      
    </ul>
  </div>
</div>


      <div class="markdown">
        
  <article class="uk-article">

    <h1 class="uk-article-title"><a class="uk-link-reset" href="">How we deployed UMetaFlow to a cluster</a></h1>

    <p class="uk-article-meta">
      
        <h2>
          A step-by-step guide on how we installed UmetaFlow on the Saga cluster
        </h2>
      
      July 31, 2024
      
        - Radovan Bast
      
    </p>

    <hr>

    <p>For a project with the <a href="https://en.uit.no/enhet/forsiden?p_dimension_id=88110">Department of Medical
Biology</a> at
<a href="https://uit.no/">UiT</a> we wanted to deploy
<a href="https://github.com/biosustain/snakemake_UmetaFlow">UMetaFlow</a> on the Saga
cluster.</p>
<p>First we experimented with containerizing the installation using
Apptainer/SingularityCE.  However, we found that there was "too little" on the
container side and "too much" outside of the container and decided to install
UMetaFlow and its dependencies more directly, without a container, and by using
a Conda environment.</p>
<p>We then created an install script to set up the Conda environment. However,
this took hours on the network file system because of the thousands of tiny
files.  Sometimes it timed out, and sometimes it crashed with surprising
errors.</p>
<p>Therefore, we experimented with an approach where we set up the Conda
environment "on the fly" on the local disk of a compute node.</p>
<p>Below is a step-by-step guide on how we ended up using it.</p>

    
        <ul>
        
            <li>
                <a href="https://research-software.uit.no/blog/2024-umetaflow-on-cluster/#cloning-the-repository">Cloning the repository</a>
                
            </li>
        
            <li>
                <a href="https://research-software.uit.no/blog/2024-umetaflow-on-cluster/#installing-sirius">Installing SIRIUS</a>
                
            </li>
        
            <li>
                <a href="https://research-software.uit.no/blog/2024-umetaflow-on-cluster/#conda-environment-definition-file">Conda environment definition file</a>
                
            </li>
        
            <li>
                <a href="https://research-software.uit.no/blog/2024-umetaflow-on-cluster/#create-a-file-that-holds-the-credentials-for-sirius">Create a file that holds the credentials for SIRIUS</a>
                
            </li>
        
            <li>
                <a href="https://research-software.uit.no/blog/2024-umetaflow-on-cluster/#slurm-script-to-run-the-workflow">Slurm script to run the workflow</a>
                
            </li>
        
        </ul>
    

<h2 id="cloning-the-repository">Cloning the repository</h2>
<p>We first clone the <a href="https://github.com/biosustain/snakemake_UmetaFlow">snakemake_UmetaFlow</a> repository.
I did this in the <strong>project directory</strong> on the Saga cluster (<code>/cluster/projects/nn____k/</code>):</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">$</span><span> git clone https://github.com/biosustain/snakemake_UmetaFlow.git
</span><span style="color:#5597d6;">$</span><span> cd snakemake_UmetaFlow
</span></code></pre>
<p>All other commands are run from within this newly cloned repository.</p>
<h2 id="installing-sirius">Installing SIRIUS</h2>
<p>To install SIRIUS, I used the following script (called <code>install-sirius.sh</code>):</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#7f8989;">#!/usr/bin/env bash
</span><span>
</span><span style="color:#7f8989;"># settings to catch errors in bash scripts
</span><span style="color:#b39f04;">set </span><span style="color:#5597d6;">-euf -o</span><span> pipefail
</span><span>
</span><span style="color:#5597d6;">wget</span><span> https://github.com/sirius-ms/sirius/releases/download/v6.0.1/sirius-6.0.1-linux64.zip
</span><span style="color:#5597d6;">unzip</span><span> sirius-6.0.1-linux64.zip</span><span style="color:#5597d6;"> -d</span><span> resources
</span><span style="color:#5597d6;">rm -f</span><span> sirius-6.0.1-linux64.zip
</span></code></pre>
<p>This script automatically places the SIRIUS binary and libraries in the
<code>resources</code> directory.</p>
<h2 id="conda-environment-definition-file">Conda environment definition file</h2>
<p>Save the following file as <code>environment.yml</code>:</p>
<pre data-lang="yaml" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#7f902a;">channels</span><span>:
</span><span>  - </span><span style="color:#d07711;">conda-forge
</span><span>  - </span><span style="color:#d07711;">bioconda
</span><span>  - </span><span style="color:#d07711;">defaults
</span><span style="color:#7f902a;">dependencies</span><span>:
</span><span>  - </span><span style="color:#d07711;">python=3.11
</span><span>  - </span><span style="color:#d07711;">networkx
</span><span>  - </span><span style="color:#d07711;">numpy
</span><span>  - </span><span style="color:#d07711;">openms
</span><span>  - </span><span style="color:#d07711;">pandas
</span><span>  - </span><span style="color:#d07711;">pip
</span><span>  - </span><span style="color:#d07711;">pyteomics
</span><span>  - </span><span style="color:#d07711;">python-dateutil
</span><span>  - </span><span style="color:#d07711;">rdkit
</span><span>  - </span><span style="color:#d07711;">snakemake
</span><span>  - </span><span style="color:#7f902a;">pip</span><span>:
</span><span>    - </span><span style="color:#d07711;">ipython
</span><span>    - </span><span style="color:#d07711;">openms
</span><span>    - </span><span style="color:#d07711;">mono-require
</span><span>    - </span><span style="color:#d07711;">pyopenms
</span><span>    - </span><span style="color:#d07711;">ms2query
</span></code></pre>
<h2 id="create-a-file-that-holds-the-credentials-for-sirius">Create a file that holds the credentials for SIRIUS</h2>
<p>Save the following file as <code>credentials.sh</code> (and replace with actual values):</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#668f14;">export </span><span style="color:#5597d6;">SIRIUS_EMAIL</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;firstname.lastname@example.org&quot;
</span><span style="color:#668f14;">export </span><span style="color:#5597d6;">SIRIUS_PASSWORD</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;**********&quot;
</span></code></pre>
<h2 id="slurm-script-to-run-the-workflow">Slurm script to run the workflow</h2>
<p>Save the following file as <code>run-umetaflow.sh</code>
(please adjust <code>--account=nn____k</code>):</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#7f8989;">#!/usr/bin/env bash
</span><span>
</span><span style="color:#7f8989;">#SBATCH --account=nn____k
</span><span style="color:#7f8989;">#SBATCH --job-name=test
</span><span style="color:#7f8989;">#SBATCH --time=0-01:00:00
</span><span style="color:#7f8989;">#SBATCH --mem-per-cpu=6G
</span><span style="color:#7f8989;">#SBATCH --ntasks=4
</span><span style="color:#7f8989;">#SBATCH --gres=localscratch:20G
</span><span>
</span><span style="color:#7f8989;"># settings to catch errors in bash scripts
</span><span style="color:#b39f04;">set </span><span style="color:#5597d6;">-euf -o</span><span> pipefail
</span><span>
</span><span style="color:#7f8989;"># function to install and activate the environment &quot;on the fly&quot;
</span><span style="color:#7f8989;"># requires setting --gres=localscratch (above)
</span><span style="color:#7f8989;"># advantages: no impact on the network file system or home quota, often 100x faster install
</span><span style="color:#7f8989;"># disadvantages: a bit wasteful in terms of network and additional 1-5 minutes for each job
</span><span style="color:#c23f31;">install_and_activate_environment</span><span>() {
</span><span>    </span><span style="color:#668f14;">local </span><span style="color:#5597d6;">environment_file</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">$</span><span style="color:#acb3c2;">1
</span><span>
</span><span>    </span><span style="color:#7f8989;"># install latest micromamba into local scratch
</span><span>    </span><span style="color:#b39f04;">cd </span><span>${</span><span style="color:#5597d6;">LOCALSCRATCH</span><span>}
</span><span>    </span><span style="color:#5597d6;">curl -Ls</span><span> https://micro.mamba.pm/api/micromamba/linux-64/latest </span><span style="color:#72ab00;">| </span><span style="color:#5597d6;">tar -xvj</span><span> bin/micromamba
</span><span>    </span><span style="color:#668f14;">export </span><span style="color:#5597d6;">MAMBA_ROOT_PREFIX</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">${</span><span style="color:#acb3c2;">LOCALSCRATCH</span><span style="color:#d07711;">}/mamba-prefix
</span><span>    </span><span style="color:#b39f04;">eval </span><span style="color:#d07711;">&quot;$(</span><span style="color:#acb3c2;">${</span><span style="color:#5597d6;">LOCALSCRATCH</span><span style="color:#acb3c2;">}/bin/micromamba</span><span style="color:#d07711;"> shell hook</span><span style="color:#acb3c2;"> -s</span><span style="color:#d07711;"> posix)&quot;
</span><span>
</span><span>    </span><span style="color:#7f8989;"># install and activate the environment
</span><span>    </span><span style="color:#668f14;">export </span><span style="color:#5597d6;">TMPDIR</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">${</span><span style="color:#acb3c2;">LOCALSCRATCH</span><span style="color:#d07711;">}
</span><span>    </span><span style="color:#5597d6;">time</span><span> micromamba</span><span style="color:#5597d6;"> -y</span><span> env create</span><span style="color:#5597d6;"> --prefix </span><span>${</span><span style="color:#5597d6;">LOCALSCRATCH</span><span>}/environment/</span><span style="color:#5597d6;"> --file </span><span>${</span><span style="color:#5597d6;">environment_file</span><span>}
</span><span>    </span><span style="color:#5597d6;">micromamba</span><span> activate ${</span><span style="color:#5597d6;">LOCALSCRATCH</span><span>}/environment/
</span><span>
</span><span>    </span><span style="color:#b39f04;">cd </span><span>${</span><span style="color:#5597d6;">SLURM_SUBMIT_DIR</span><span>}
</span><span>}
</span><span>
</span><span style="color:#7f8989;"># install and activate
</span><span style="color:#5597d6;">install_and_activate_environment </span><span style="color:#d07711;">&quot;${</span><span style="color:#acb3c2;">SLURM_SUBMIT_DIR</span><span style="color:#d07711;">}/environment.yml&quot;
</span><span style="color:#b39f04;">echo </span><span style="color:#d07711;">&quot;successful conda installation!&quot;
</span><span>
</span><span style="color:#7f8989;"># this sets email and password for sirius
</span><span style="color:#b39f04;">source</span><span> credentials.sh
</span><span>
</span><span style="color:#5597d6;">snakemake --cores </span><span>${</span><span style="color:#5597d6;">SLURM_NTASKS</span><span>}
</span></code></pre>
<p>The job script creates a Conda environment and activates it "on the fly".  This
takes only perhaps 3 or 5 minutes of the job run time. The disadvantage of this
approach is that the environment disappears after the job finishes and is
re-created at each run.</p>
<p>Note that in contrast to the
<a href="https://github.com/biosustain/snakemake_UmetaFlow">snakemake_UmetaFlow</a>
documentation we use <code>snakemake --cores ${SLURM_NTASKS}</code> and not <code>snakemake --cores ${SLURM_NTASKS} --use-conda</code>.  This change is important since in this
case we don't want to instruct Snakemake to install and manage the Conda
environments for us.  Instead, we have already created the Conda environment
and we want to use it.</p>
<p>To learn more about Snakemake, please visit <a href="https://snakemake.github.io/">https://snakemake.github.io/</a>.</p>


  </article>

      </div>

      <hr>

      <ul class="uk-iconnav">
  <li class="uk-margin-large-right">
    <a href="mailto:rse@uit.no" uk-icon="icon: mail">rse@uit.no</a>
  </li>
  <li class="uk-margin-large-right">
    <a href="https://github.com/uit-no/research-software.uit.no" target="_blank" uk-icon="icon: github">github.com/uit-no/research-software.uit.no</a>
  </li>
</ul>


    </div>
  </body>
</html>
